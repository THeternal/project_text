<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta
	http-equiv="X-UA-Compatible"
	content="IE=edge,chrome=1" />
<meta
	name="viewport"
	content="width=device-width, initial-scale=1, maximum-scale=1" />
<link
	rel="stylesheet"
	th:href="@{/layui/css/layui.css}"
	media="all" />
<link
	rel="stylesheet"
	th:href="@{/layui/css/global.css}" />
<link
	rel="stylesheet"
	href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.css" />

<style type="text/css">
.param_imgs_player {
	max-width: 150px;
}

.param_imgs {
	width: 200px;
	height: 300px;
}

.player_card_img {
	max-width: 300px;
	max-height: 200px;
}
</style>
</head>
<body class="layui-fluid">
	<blockquote
		class="layui-elem-quote"
		style="background-color: #F0F0F0;">
		<div class="layui-row layui-col-md-offset8">
			<button
				class="layui-btn layui-btn-primary"
				onclick="history.back();">
				<i
					class="fa fa-arrow-left"
					aria-hidden="true"></i>&nbsp;返回
			</button>
		</div>
	</blockquote>
	<div
		class="layui-card"
		style="margin-top: 10px;">
		<div class="layui-card-header">
			<i
				class="fa fa-cogs"
				aria-hidden="true"></i>&nbsp;<font
				color="#009688"
				style="font-weight: bold;">基本信息</font>
		</div>
		<div class="layui-card-body layui-form">
			<div class="layui-form-item">

				<div class=" layui-col-md10 layui-col-sm10">
					<label class="layui-form-label">标题<font color="red">*</font>：</label>
					<div class="layui-input-block">
						<input
							type="text"
							class="layui-input param_title"
							th:value="${pageData.title}"
							placeholder="请输入标题" />
					</div>
				</div>
			</div>
			<div class="layui-form-item">

				<div class=" layui-col-md4 layui-col-sm4">
					<label class="layui-form-label">发起人<font color="red">*</font>：</label>
					<div class="layui-input-block">
						<input
							type="text"
							readonly="readonly"
							th:value="${pageData.nickName}"
							class="layui-input layui-word-aux param_userId" />
					</div>
				</div>

				<div class=" layui-col-md4 layui-col-sm4">
					<label class="layui-form-label">奖励金额<font color="red">*</font>：</label>
					<div class="layui-input-block">
						<input
							type="text"
							readonly="readonly"
							class="layui-input param_rewardPrice"
							th:value="${pageData.rewardPrice}"
							placeholder="请输入奖励信息" />
					</div>
				</div>

				<div class=" layui-col-md4 layui-col-sm4 ">
					<label class="layui-form-label">限制人数<font color="red">*</font>：</label>
					<div class="layui-input-block">
						<input
							type="text"
							class="layui-input param_maxPeopleNum"
							readonly="readonly"
							th:value="${pageData.maxPeopleNum}"
							placeholder="请输入限制人数" />
					</div>
				</div>

			</div>
			<div class="layui-form-item">
				<div class=" layui-col-md4 layui-col-sm4">
					<label class="layui-form-label">所需费用<font color="red">*</font>：</label>
					<div class="layui-input-block">
						<input
							type="text"
							readonly="readonly"
							th:value="${pageData.totalPrice}"
							class="layui-input" />
					</div>
				</div>
				<div class=" layui-col-md4 layui-col-sm4 ">
					<label class="layui-form-label">上下架<font color="red">*</font>：</label>
					<div class="layui-input-inline">
						<input
							type="checkbox"
							lay-skin="switch"
							th:checked="${pageData.investigateStatus}"
							class="param_investigateStatus"
							lay-text="是|否" />
					</div>
				</div>
				<div class=" layui-col-md4 layui-col-sm4">
					<label class="layui-form-label">结束时间<font color="red">*</font>：</label>
					<div class="layui-input-block">
						<input
							type="text"
							class="layui-input param_endTime"
							th:value="${pageData.endTimeStr}"
							placeholder="结束时间" />
					</div>
				</div>
			</div>
		</div>
	</div>

	<div
		class="layui-card"
		style="margin-top: 10px;">
		<div class="layui-card-header">
			<i
				class="fa fa-home"
				aria-hidden="true"></i>&nbsp;<font
				color="#009688"
				style="font-weight: bold;">企业信息</font>
		</div>
		<div class="layui-card-body">
			<div class="layui-form-item">
				<div class=" layui-col-md6 layui-col-sm6">
					<label class="layui-form-label">发起人单位<font color="red">*</font>：</label>
					<div class="layui-input-block">
						<input
							type="text"
							class="layui-input param_initiatorUnit"
							th:value="${pageData.initiatorUnit}"
							placeholder="请输入发起人单位" />
					</div>
				</div>
			</div>

			<div class="layui-form-item">
				<div class=" layui-col-md6 layui-col-sm6">
					<label class="layui-form-label">广告说明：</label>
					<div class="layui-input-block">
						<textarea
							type="text"
							class="layui-textarea param_advertisingExplain"
							th:text="${pageData.advertisingExplain}"
							placeholder="请输入广告说明" />
					</div>
				</div>
			</div>

			<div class="layui-form-item">
				<label class="layui-form-label">广告图：</label>
				<div
					class="layui-col-md10 layui-col-sm10"
					id="img_ad"></div>
				<div
					class="layui-col-md10 layui-col-sm10"
					style="margin: 10px 0px;">
					<div class="layui-input-block">
						<button
							type="button"
							class="layui-btn"
							id="upload_img_ad">
							<i class="layui-icon">&#xe67c;</i>上传图片
						</button>
					</div>
				</div>
			</div>

		</div>
	</div>

	<div
		class="layui-card"
		style="margin-top: 10px;">
		<div class="layui-card-header">
			<i
				class="fa fa-list-alt"
				aria-hidden="true"></i>&nbsp;<font
				color="#009688"
				style="font-weight: bold;">投票信息</font>
		</div>
		<div class="layui-card-body">

			<div class="layui-form-item">
				<div class=" layui-col-md6 layui-col-sm6">
					<label class="layui-form-label">投票说明<font color="red">*</font>：</label>
					<div class="layui-input-block">
						<textarea
							type="text"
							class="layui-textarea param_investigateExplain"
							th:text="${pageData.investigateExplain}"
							placeholder="请输入投票说明" />
					</div>
				</div>
			</div>

			<div class="layui-form-item">
				<label class="layui-form-label">广告图：</label>
				<div
					class="layui-col-md10 layui-col-sm10"
					id="img_vote_ad"></div>
				<div
					class="layui-col-md10 layui-col-sm10"
					style="margin: 10px 0px;">
					<div class="layui-input-block">
						<button
							type="button"
							class="layui-btn"
							id="upload_img_vote">
							<i class="layui-icon">&#xe67c;</i>上传图片
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>


	<div
		class="layui-card layui-form"
		style="margin-top: 10px;">
		<div class="layui-card-header">
			<i
				class="fa fa-paper-plane-o"
				aria-hidden="true"></i>&nbsp;<font
				color="#009688"
				style="font-weight: bold;">投票区<font color="red">*</font></font>
		</div>
		<div class="layui-card-body">
			<table
				class="layui-hide"
				id="pageData"></table>

		</div>
	</div>


	<blockquote
		class="layui-elem-quote"
		style="background-color: #F0F0F0;">
		<div class="layui-row layui-col-md-offset8">
			<button
				class="layui-btn"
				onclick="addVote()">
				<i
					class="fa fa-pencil-square-o"
					aria-hidden="true"></i>&nbsp;更新
			</button>
			<button
				class="layui-btn layui-btn-primary"
				onclick="history.back();">
				<i
					class="fa fa-arrow-left"
					aria-hidden="true"></i>&nbsp;返回
			</button>
		</div>
	</blockquote>
</body>
<script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js "></script>
<script
	th:src="@{/layui/layui.js}"
	charset="utf-8"></script>
<script
	th:src="@{/js/kemean_layui.js}"
	charset="utf-8"></script>
<script
	type="text/javascript"
	th:inline="javascript">
	var url_page_list_data = /*[[@{/admin/invest/}]]*/;
	var url_page_palyer_list_data = /*[[@{/admin/invest/vote_player_data(objId=${pageData.id})}]]*/;
	var url_upload_img = /*[[@{/admin/open/qiniu_batch_upload}]]*/;
	var url_vote_add = /*[[@{/admin/invest/vote_operate}]]*/;
	var url_page_palyer_edit = /*[[@{/admin/invest/vote_player_edit}]]*/;
	var url_vote_player_page = /*[[@{/admin/invest/vote_player_page}]]*/;
	var pageData=/*[[${pageData}]]*/;
	
	var upload;
	 var table;
	  var myIndex=0;
    layui.use(['table', 'layer','form','upload','laydate'], function () {
    	var  form=layui.form;
    	 upload=layui.upload;
    	 var laydate = layui.laydate;
    	 table=layui.table;
    	
    	  laydate.render({
    	    elem: '.param_endTime'
    	    ,type: 'datetime'
    	  });
    	  
    	  //广告
			var uploadInst = upload.render({
				elem : '#upload_img_ad',
				data:{resetName:true},
				multiple:true,
				url : url_upload_img,
				done : function(res) {
					var imgHtml='<div id="delImgAd'+myIndex+'" class="layui-col-md3 layui-col-sm3"><div style="margin-left: 197px;"><i class="fa fa-times" aria-hidden="true" onclick="delImgAd('+myIndex+')"></i></div>'
					+'<img class="param_imgs_ad" src="'+res.data+'" width="200px" onclick="visitImg(this.src);" /></div>';
					var imgNum=$("#img_ad .param_imgs_ad").length;
					if(5>imgNum){
						$("#img_ad").append(imgHtml);
						myIndex++;
						layer.msg("上传成功");
					}else{
						layer.msg("最多只能上传五张");
						return false;
					}
					
					
				}
			});
		
    	  
   	  	//投票说明
    	   upload.render({
				elem : '#upload_img_vote',
				data:{resetName:true},
				url : url_upload_img,
				multiple:true,
				done : function(res) {
						var imgHtml='<div id="delImgVote'+myIndex+'" class="layui-col-md3 layui-col-sm3" ><div style="margin-left: 197px;"><i class="fa fa-times" aria-hidden="true" onclick="delImgVote('+myIndex+')"></i></div>'
						+'<img class="param_imgs param_imgs_vote" src="'+res.data+'" onclick="visitImg(this.src);" /></div>';
						var imgNum=$("#img_vote_ad .param_imgs_vote").length;
						if(5>imgNum){
							$("#img_vote_ad").append(imgHtml);
							myIndex++;
							layer.msg("上传成功");
						}else{
							layer.msg("最多只能上传五张");
							return false;
						}
					}
			});
   	  
   	  
    			//选手图片
    	 	   upload.render({
    					elem : '#upload_img_player',
    					data:{resetName:true},
    					url : url_upload_img,
    					multiple:true,
    					done : function(res) {
    							var imgHtml='<div id="delImgPlayer'+myIndex+'" class="layui-col-md5 layui-col-sm4 playImg_div"><div style="margin-left: 146px;"><i class="fa fa-times" aria-hidden="true" onclick="delImgPlayer('+myIndex+')"></i></div>'
    							+'<img class="param_imgs_player param_imgs_player" src="'+res.data+'" onclick="visitImg(this.src);" /></div>';
    							var imgNum=$("#player_img .param_imgs_player").length;
    							if(5>imgNum){
    								$("#player_img").append(imgHtml);
    								myIndex++;
    							}else{
    								layer.msg("最多只能上传五张");
    								return false;
    							}
    						}
    				});
   	  
    			

    	        table.render({
    	            elem: '#pageData',
    	            url: url_page_palyer_list_data,
    	            cols: [[
    	            	{
    	            		templet : '#imgTemplet',
    	                    title: '选手图片',
    	                },{
    		                field: 'name',
    		                title: '选手姓名'
    		            }, {
    		                title: '选手说明',
    		                field: 'explainStr'
    		            },{
    	                    field: 'votes',
    	                    title: '获得票数'
    	                },{
    	                    field: 'popularity',
    	                    title: '人气'
    	                },{
    	                    toolbar: "#operate",
    	                    title: '操作',
    	                    width:280
    	                }]],
    	            page: true,
    	            id: 'dataTable'
    	        });
    });
    
    
    $(function(){
		//企业说明--广告图
		
		$.each(pageData.advertisingImg, function(i, elt) {
			var imgHtml='<div id="delImgAd'+i+'" class="layui-col-md3 layui-col-sm3"><div style="margin-left: 197px;"><i class="fa fa-times" aria-hidden="true" onclick="delImgAd('+i+')"></i></div>'
			+'<img class="param_imgs_ad" src="'+elt+'" width="200px" onclick="visitImg(this.src);" /></div>';
				$("#img_ad").append(imgHtml);
		})		
		
	//调研说明--广告图
		
		$.each(pageData.investigateImg, function(i, elt) {
			var imgHtml='<div id="delImgVote'+i+'" class="layui-col-md3 layui-col-sm3" ><div style="margin-left: 197px;"><i class="fa fa-times" aria-hidden="true" onclick="delImgVote('+i+')"></i></div>'
			+'<img class="param_imgs_vote" src="'+elt+'" onclick="visitImg(this.src);" /></div>';
				$("#img_vote_ad").append(imgHtml);
		})		
	});
    
    
    
	 
    //删除投票说明照片
	function delImgVote(i){
		$("#delImgVote"+i).remove();
	}
	
	 //删除广告说明照片
	function delImgAd(i){
		$("#delImgAd"+i).remove();
	}
	
	
	//删除选手
	function delPlayer(i){
		$("#playerCard"+i).remove();
	}
	
	
	
	
	

	//添加选手信息
	function addPlayer(){
		$("#player_div").removeClass("layui-hide");
		$(".param_name").val('');
		$(".param_explain_str").val('');
		$(".playImg_div").remove();
		layer.open({
			type:1,
			title : "添加选手信息",
			content :$("#player_div"),
			skin : "layui-layer-molv",
			area: ['511px','454px'],
			btn : [ '添加' ],
			offset: '100px',
			btn1 : function(index) {
				
			  	var param_name=$(".param_name").val();
				var param_explain_str=$(".param_explain_str").val();
				if(!param_name){
					layer.msg("请输入选手姓名");
					return false;
				}
				if(!param_explain_str){
					layer.msg("请输入选手说明");
					return false;
				}
				
				var imgsList=new Array();
				$("#player_img .param_imgs_player").each(function(i, element) {
					imgsList.push(element.src);
				});
				
				if(0 == imgsList.length){
					layer.msg("选手的图片不能为空");
					return false;
				}
				
				 playerListDiv(imgsList,param_name,param_explain_str); 
				 
				 $("#player_div").addClass("layui-hide");
				 layer.close(index);
				
			},
			closeBtn : 1,
			anim : 0,
		});
		
	}

	
	function uploadPlayer(){
		 upload.render({
				elem : '#uploadPlayer',
				data:{resetName:true},
				url : url_upload_img,
				done : function(res) {
					
						var imgHtml='<div id="delImgPlayer'+myIndex+'" class="layui-col-md5 layui-col-sm4 playImg_div"><div style="margin-left: 146px;"><i class="fa fa-times" aria-hidden="true" onclick="delImgPlayer('+myIndex+')"></i></div>'
						+'<img class="param_imgs_player param_imgs_player" src="'+res.data+'" onclick="visitImg(this.src);" /></div>';
						var imgNum=$("#player_img .param_imgs_player").length;
						if(5>imgNum){
							$("#player_img").append(imgHtml);
							myIndex++;
						}else{
							layer.msg("最多只能上传五张");
							return false;
						}
						console.log("上传成功");
					}
					
			});
	}
	
	
	//编辑选手信息
	function editPlayer(i,name,explainStr,palyerImgs){
		
		
		var imgs=new Array();
		$(palyerImgs.split(",")).each(function(i, element) {
			imgs.push(element);
		});
		
		var player=new Object;
		player.name=name;
		player.explainStr=explainStr;
		player.imgs=imgs;
		
		var playerContent=JSON.stringify(player);
		
		console.log(playerContent);
		
		layer.open({
			type:2,
			title : "修改选手信息",
			content :url_vote_player_page+'?playerContent='+playerContent,
			skin : "layui-layer-molv",
			area: ['490px','452px'],
			btn : [ '修改' ],
			offset: '100px',
			btn1 : function(index) {
			  	var param_name=$(".param_name").val();
				var param_explain_str=$(".param_explain_str").val();
				if(!param_name){
					layer.msg("请输入选手姓名");
					return false;
				}
				if(!param_explain_str){
					layer.msg("请输入选手说明");
					return false;
				}
				
				var imgsList=new Array();
				$("#player_img .param_imgs_player").each(function(i, element) {
					imgsList.push(element.src);
				});
				
				if(0 == imgsList.length){
					layer.msg("选手的图片不能为空");
					return false;
				}
				
				 playerListDiv(imgsList,param_name,param_explain_str); 
				 
				 layer.close(index);
				 delPlayer(i);
			},
			closeBtn : 1,
			anim : 0,
		});
		
		
		
	}
	
	 function resetPlayerDiv(name,explainStr,votes,popularity){
			return	  '<div class="layui-form-item"><label class="layui-form-label">选手姓名:</label>'
					 +'<div class="layui-input-block"><input type="text" class="layui-input param_name" value="'+name+'" placeholder="请输入选手姓名" /></div></div>'
					 +'<div class="layui-form-item"><label class="layui-form-label">选手说明:</label>'
					 +'<div class="layui-input-block"><input type="text" class="layui-input param_explainStr" value="'+explainStr+'" placeholder="请输入选手说明"/></div></div>'
					 +'<div class="layui-form-item"><label class="layui-form-label">获得票数:</label>'
					 +'<div class="layui-input-block"><input type="text" class="layui-input param_votes" value="'+votes+'" placeholder="请输入获得的票数"/></div></div>'
					 +'<div class="layui-form-item"><label class="layui-form-label">人气:</label>'
					 +'<div class="layui-input-block"><input type="text" class="layui-input param_popularity" value="'+popularity+'" placeholder="请输入人气数"/></div></div>'
		}
		
	
	function resetPlayer(objId,name,explainStr,votes,popularity){
		layer.open({
			title : "修改选手信息",
			content :resetPlayerDiv(name,explainStr,votes,popularity),
			skin : "layui-layer-molv",
			area : [ '387px', '395px' ],
			btn : [ '修改' ],
			offset: '100px',
			btn1 : function() {
				var param_name=$(".param_name").val();
				var param_explainStr=$(".param_explainStr").val();
				var param_votes=$(".param_votes").val();
				var param_popularity=$(".param_popularity").val();
				
				if(!param_name){
					layer.msg("请输入选手名称");
					return false;
				}
				if(!param_explainStr){
					layer.msg("请输入选手说明");
					return false;
				}
				if(!param_votes){
					layer.msg("请输入选手获得的票数");
					return false;
				}
				if(!param_popularity){
					layer.msg("请输入选手的人气数");
					return false;
				}
				
				$.post(url_page_palyer_edit, 
						{name:param_name,
						explainStr:param_explainStr,
						votes:param_votes,
						popularity:param_popularity,
						objId:objId}, function(data, textStatus, req) {
							layer.msg(data.info);
							table.reload("dataTable");
				});
			},
			closeBtn : 1,
			anim : 0
		})	
	}
	
	
	//添加投票信息
	function addVote(){
		
		var param_title = $(".param_title").val();
		
		if(!param_title){
			layer.msg('标题不能为空');
			return false;
		}
		
		var param_rewardPrice=$(".param_rewardPrice").val();
		if(!param_rewardPrice){
			layer.msg('奖励信息不能为空');
			return false;
		}
		
		var param_maxPeopleNum=$(".param_maxPeopleNum").val();
		if(!param_maxPeopleNum){
			layer.msg('限制人数不能为空');
			return false;
		}
		
		var param_endTime = $(".param_endTime").val();
		if (!param_endTime) {
			layer.msg('结束时间不能为空');
			return false;
		}
		 
		var date =new Date();
		if(date>Date.parse(param_endTime)){
			
				layer.msg('结束时间不能小于当前时间');
				return false;
		}
		
		
		var param_initiatorUnit = $(".param_initiatorUnit").val();
		if(!param_initiatorUnit){
			layer.msg('发起人单位不能为空');
			return false;
		}
		
		var advertisingImg=new Array();
		$("#img_ad .param_imgs_ad").each(function(i, element) {
			advertisingImg.push(element.src);
		});
		
		
		var param_investigateExplain = $(".param_investigateExplain").val();
		if(!param_investigateExplain){
			layer.msg('广告说明不能为空');
			return false;
		}
		
		var param_advertisingExplain = $(".param_advertisingExplain").val();
		
		
		var investigateImg=new Array();
		$("#img_vote_ad .param_imgs_vote").each(function(i, element) {
			investigateImg.push(element.src);
		});
		
		
		var param_investigateStatus=$(".param_investigateStatus").prop("checked");
		
		
		
		$.ajax({
			type:"POST",
			url:url_vote_add,
			contentType: "application/json; charset=utf-8",
			dataType:"json",
			data:JSON.stringify({userId:pageData.userId,objId:pageData.id,title:param_title,rewardPrice:param_rewardPrice,maxPeopleNum:param_maxPeopleNum, endTime:param_endTime,advertisingExplain:param_advertisingExplain,
				initiatorUnit:param_initiatorUnit,advertisingImg:advertisingImg,investigateExplain:param_investigateExplain,investigateImg:investigateImg,investigateStatus:param_investigateStatus
				}),
			success:function(data){
				showResultMsgAndJumpByFlag(data.success,data.info,url_page_list_data);
	    	}
		});
		
	}
	
</script>

<script
	type="text/javascript"
	id="imgTemplet">
		<img src="{{d.img}}" width="200px" onclick="visitImg('{{d.img}}')" />
</script>

<script
	type="text/html"
	id="operate">
		<button class="layui-btn layui-btn-sm" onclick="resetPlayer({{d.objId}},{{d.name}},{{d.explainStr}},
					{{d.votes}},{{d.popularity}})"><i
				class="fa fa-edit"
				aria-hidden="true"></i>&nbsp;修改</button> 
</script>
</html>